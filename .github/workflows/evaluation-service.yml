name: Evaluation Service CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: false
      - name: Tidy modules
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: go mod tidy
      - name: Download modules
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: go mod download
      - name: Build
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: go build ./...
      - name: Unit tests (if present)
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: |
          if ls *_test.go >/dev/null 2>&1; then go test ./...; else echo "No Go tests"; fi
      - name: Build image
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: docker build -t evaluation-service:ci -f Dockerfile .

  lint:
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: false
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.61.0
          args: --timeout=5m ./Kubernetes/evaluation-service/evaluation-service/...
          skip-cache: true

  security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: false
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      - name: Run gosec (high only)
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: gosec -severity high ./...
      - name: Trivy SCA (fail on critical)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: Kubernetes/evaluation-service/evaluation-service
          severity: CRITICAL
          exit-code: "1"

  docker_build_push:
    runs-on: ubuntu-latest
    needs: security
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image
        working-directory: Kubernetes/evaluation-service/evaluation-service
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker build -t evaluation-service:${COMMIT_SHA} -f Dockerfile .
          docker tag evaluation-service:${COMMIT_SHA} evaluation-service:latest
      - name: Trivy Container Scan (fail on critical)
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image --severity CRITICAL --exit-code 1 \
            evaluation-service:${COMMIT_SHA}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      - name: Push to ECR
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          ECR_REGISTRY=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
          ECR_REPO=${{ secrets.PROJECT_NAME }}/evaluation-service
          docker tag evaluation-service:${COMMIT_SHA} $ECR_REGISTRY/$ECR_REPO:${COMMIT_SHA}
          docker tag evaluation-service:${COMMIT_SHA} $ECR_REGISTRY/$ECR_REPO:latest
          docker push $ECR_REGISTRY/$ECR_REPO:${COMMIT_SHA}
          docker push $ECR_REGISTRY/$ECR_REPO:latest
      - name: Update GitOps manifest
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          ECR_REGISTRY=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
          ECR_REPO=${{ secrets.PROJECT_NAME }}/evaluation-service
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          sed -i "s|image:.*|image: $ECR_REGISTRY/$ECR_REPO:${COMMIT_SHA}|g" gitops/manifests/evaluation-service/deployment.yaml
          git add gitops/manifests/evaluation-service/deployment.yaml
          git commit -m "[GitOps] Update evaluation-service image to ${COMMIT_SHA}" || echo "No changes to commit"
          git push origin main
